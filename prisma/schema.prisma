// This is your Prisma schema file documentation: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  schemas  = ["auth", "habitracker_app"]
}

// --- ENUMS ---

enum TaskType {
  HABIT
  ROUTINE
  TODO
  MINDSET

  @@schema("habitracker_app")
}

enum HabitDirection {
  POSITIVE // Increase/Maintain
  NEGATIVE // Decrease/Quit

  @@schema("habitracker_app")
}

enum TaskPriority {
  NONE
  LOW
  MEDIUM
  HIGH
  URGENT

  @@schema("habitracker_app")
}

enum SubscriptionTier {
  FREE
  PRO
  LIFETIME

  @@schema("habitracker_app")
}

enum PostType {
  TEXT
  ACHIEVEMENT
  CHALLENGE_CREATED
  CHALLENGE_ON_TRACK
  CHALLENGE_COMPLETED
  IMAGE

  @@schema("habitracker_app")
}

enum PostVisibility {
  PUBLIC
  PRIVATE

  @@schema("habitracker_app")
}

enum ChallengeStatus {
  ACTIVE
  COMPLETED
  CANCELLED

  @@schema("habitracker_app")
}

// --- REFERENCE TABLES (seeded; new type = new row, no migration) ---

model NotificationTypeRef {
  id          String        @id @default(uuid()) @db.Uuid
  code        String        @unique  // e.g. FOLLOW, LIKE_POST
  name        String        // Display name
  description String?
  notifications Notification[]

  @@map("notification_type")
  @@schema("habitracker_app")
}

model AchievementDefinition {
  id            String        @id @default(uuid()) @db.Uuid
  code          String        @unique  // e.g. CHALLENGE_COMPLETED, STREAK_7
  name          String
  description   String?
  pointsDefault Int           @default(0)
  isActive      Boolean       @default(true)
  sortOrder     Int           @default(0)
  rewardEvents  RewardEvent[]

  @@map("achievement_definition")
  @@schema("habitracker_app")
}

// --- AUTH SCHEMA MODELS (Shared Identity) ---

model User {
  id               String           @id @default(uuid()) @db.Uuid
  email            String
  name             String?
  lastName         String?
  emailVerified    Boolean
  image            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  // Multi-tenancy support
  originAppId      String           @default("habitracker")
  
  lastActive       DateTime?
  deletedAt        DateTime?

  sessions         Session[]
  accounts         Account[]
  
  // Global settings (security, theme choice etc)
  settings         UserSetting[]
  
  // Application specific profiles
  habitProfile     HabitProfile?

  // Security plugins (twoFactorEnabled required by better-auth twoFactor plugin)
  twoFactorEnabled Boolean       @default(false)
  twoFactor        TwoFactor?
  passkeys         Passkey[]

  @@unique([email, originAppId]) // Key for per-app isolation
  @@index([email])
  @@map("user")
  @@schema("auth")
}

model Session {
  id        String   @id @default(uuid()) @db.Uuid
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
  @@schema("auth")
}

model Account {
  id                    String    @id @default(uuid()) @db.Uuid
  accountId             String
  providerId            String
  userId                String    @db.Uuid
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
  @@schema("auth")
}

model Verification {
  id         String   @id @default(uuid()) @db.Uuid
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
  @@schema("auth")
}

model TwoFactor {
  id          String   @id @default(uuid()) @db.Uuid
  secret      String
  backupCodes String
  userId      String   @unique @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("two_factor")
  @@schema("auth")
}

model Passkey {
  id           String   @id @default(uuid()) @db.Uuid
  name         String?
  publicKey    String
  userId       String   @db.Uuid
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("passkey")
  @@schema("auth")
}

model UserSetting {
  id        String  @id @default(uuid()) @db.Uuid
  userId    String  @db.Uuid
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  key       String
  value     String

  @@unique([userId, key])
  @@map("user_setting")
  @@schema("auth")
}

// --- HABITRACKER APP SCHEMA MODELS (Isolated Data & Profile) ---

model HabitProfile {
  userId           String           @id @db.Uuid
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  username         String           @unique
  subscriptionTier SubscriptionTier @default(FREE)
  bio              String?
  points           Int              @default(0)
  isTaggingAllowed Boolean          @default(true)
  
  // Social relations
  followers        Follow[]         @relation("following")
  following        Follow[]         @relation("follower")
  blockedBy        UserBlock[]      @relation("blockedByUser")
  blockedUsers     UserBlock[]      @relation("blockingUser")

  // App specific data
  dailyStats       DailyStats[]
  tasks            Task[]
  posts            Post[]
  challenges       ChallengeMember[]
  comments         Comment[]
  likes            Like[]
  notificationsReceived Notification[]  @relation("notificationReceiver")
  notificationsSent     Notification[]  @relation("notificationSender")
  groupMemberships      GroupMember[]
  createdChallenges     Challenge[]    @relation("challengeCreator")
  rewardEvents          RewardEvent[]
  settings              ProfileSettings?

  @@map("habit_profile")
  @@schema("habitracker_app")
}

model ProfileSettings {
  userId           String           @id @db.Uuid
  profile          HabitProfile     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  // Privacy & Social
  isSearchable     Boolean          @default(true)
  analyticsEnabled Boolean          @default(true)
  profileVisibility PostVisibility   @default(PUBLIC)
  challengeVisibility PostVisibility @default(PUBLIC)
  challengePostVisibility PostVisibility @default(PUBLIC)

  // Task Defaults
  taskDailyReminderTime String?     // HH:mm
  taskWeekStartDay     Int          @default(1) // 1=Mon, 7=Sun
  taskArchiveVisible   Boolean      @default(false)
  
  // Pomodoro Defaults
  pomodoroFocusDuration Int         @default(25)
  pomodoroBreakDuration Int         @default(5)
  pomodoroLongBreakDuration Int     @default(15)

  @@map("profile_settings")
  @@schema("habitracker_app")
}

model UserBlock {
  id             String       @id @default(uuid()) @db.Uuid
  profileId      String       @db.Uuid
  blockedId      String       @db.Uuid
  profile        HabitProfile @relation("blockingUser", fields: [profileId], references: [userId])
  blockedProfile HabitProfile @relation("blockedByUser", fields: [blockedId], references: [userId])

  @@unique([profileId, blockedId])
  @@map("user_block")
  @@schema("habitracker_app")
}

model Follow {
  followerId  String  @db.Uuid
  followingId String  @db.Uuid
  follower    HabitProfile @relation("follower", fields: [followerId], references: [userId])
  following   HabitProfile @relation("following", fields: [followingId], references: [userId])

  @@id([followerId, followingId])
  @@map("follows")
  @@schema("habitracker_app")
}

model DailyStats {
  id             String       @id @default(uuid()) @db.Uuid
  userId         String       @db.Uuid
  profile        HabitProfile @relation(fields: [userId], references: [userId])
  recordDate     DateTime     @db.Date
  totalCompleted Int          @default(0)
  activeStreak   Int          @default(0)

  @@unique([userId, recordDate])
  @@map("daily_stats")
  @@schema("habitracker_app")
}

/// Single reward event â€“ gamification history. HabitProfile.points = balance.
model RewardEvent {
  id                    String               @id @default(uuid()) @db.Uuid
  userId                String               @db.Uuid
  profile               HabitProfile         @relation(fields: [userId], references: [userId], onDelete: Cascade)
  achievementDefinitionId String             @db.Uuid
  achievementDefinition AchievementDefinition @relation(fields: [achievementDefinitionId], references: [id])
  pointsAwarded         Int                  @default(0)  // can override vs definition.pointsDefault
  sourceType            String?              // CHALLENGE | TASK | STREAK | SYSTEM
  sourceId              String?
  title                 String?
  createdAt             DateTime             @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([achievementDefinitionId])
  @@map("reward_event")
  @@schema("habitracker_app")
}

model Task {
  id             String       @id @default(uuid()) @db.Uuid
  userId         String       @db.Uuid
  profile        HabitProfile @relation(fields: [userId], references: [userId])
  categoryId     String?      @db.Uuid
  category       Category?    @relation(fields: [categoryId], references: [id])
  challengeId    String?      @db.Uuid
  challenge      Challenge?   @relation(fields: [challengeId], references: [id])
  
  type           TaskType
  title          String
  iconName       String?
  colorValue     Int?
  imageUrl       String?
  
  isPublic       Boolean      @default(false)
  isDeleted      Boolean      @default(false)
  isPredefined   Boolean      @default(false)
  forkCount      Int          @default(0)
  isForked       Boolean      @default(false)
  originalTaskId String?      @db.Uuid
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  startDate      DateTime     @default(now())
  endDate       DateTime?
  
  frequencyId    String?      @db.Uuid
  frequency      TaskFrequency? @relation(fields: [frequencyId], references: [id])
  notes          String[]

  habitDetails     HabitDetails?
  routineDetails   RoutineDetails?
  todoDetails      TodoDetails?
  mindsetDetails   MindsetDetails?
  
  reminders        TaskReminder[]
  completions      TaskCompletion[]
  pomodoroSettings PomodoroSettings?

  @@index([userId, isDeleted, createdAt(sort: Desc)])
  @@index([challengeId])
  @@map("task")
  @@schema("habitracker_app")
}

model Category {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  iconName     String?
  colorValue   Int?
  imageUrl     String?
  userId       String?  @db.Uuid // null or system user id = global/predefined
  isPredefined Boolean  @default(false)
  tasks        Task[]

  @@index([userId])
  @@map("category")
  @@schema("habitracker_app")
}

model TaskFrequency {
  id             String        @id @default(uuid()) @db.Uuid
  type           String
  daysOfWeek     Int[]         
  dayOfMonth     Int?
  interval       Int           @default(1)
  timesPerPeriod Int?
  endDate        DateTime?
  tasks          Task[]

  @@map("task_frequency")
  @@schema("habitracker_app")
}

model HabitDetails {
  taskId       String         @id @db.Uuid
  task         Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  goalValue    Float
  currentValue Float          @default(0)
  unitId       String?        @db.Uuid
  unit         TaskUnit?      @relation(fields: [unitId], references: [id])
  direction    HabitDirection @default(POSITIVE)

  @@map("habit_details")
  @@schema("habitracker_app")
}

model TaskUnit {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  symbol       String
  userId       String?  @db.Uuid // null or system user id = global/predefined
  isPredefined Boolean  @default(false)
  habits       HabitDetails[]

  @@index([userId])
  @@map("task_unit")
  @@schema("habitracker_app")
}

model RoutineDetails {
  taskId    String   @id @db.Uuid
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  steps     String[]
  startTime String?
  endTime   String?

  @@map("routine_details")
  @@schema("habitracker_app")
}

model TodoDetails {
  taskId   String        @id @db.Uuid
  task     Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  dueTime  DateTime?
  priority TaskPriority  @default(NONE)
  url      String?
  isFlagged Boolean      @default(false)
  subtasks TodoSubtask[]

  @@map("todo_details")
  @@schema("habitracker_app")
}

model MindsetDetails {
  taskId          String  @id @db.Uuid
  task            Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  affirmation     String? @db.Text
  durationMinutes Int?

  @@map("mindset_details")
  @@schema("habitracker_app")
}

model TodoSubtask {
  id            String      @id @default(uuid()) @db.Uuid
  todoDetailsId String      @db.Uuid
  todoDetails   TodoDetails @relation(fields: [todoDetailsId], references: [taskId], onDelete: Cascade)
  title         String
  isCompleted   Boolean     @default(false)

  @@map("todo_subtask")
  @@schema("habitracker_app")
}

model TaskReminder {
  id           String   @id @default(uuid()) @db.Uuid
  taskId       String   @db.Uuid
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  type         String   // TIME, LOCATION
  time         String?
  locationName String?
  latitude     Float?
  longitude    Float?
  message      String?
  isEnabled    Boolean  @default(true)

  @@map("task_reminder")
  @@schema("habitracker_app")
}

model TaskCompletion {
  id          String   @id @default(uuid()) @db.Uuid
  taskId      String   @db.Uuid
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  completedAt DateTime @default(now())
  /// Amount of units completed (e.g. 2.5 for "2.5 L water")
  value       Float?
  status      String?
  /// Short note for this completion
  notes       String?
  /// Optional longer description or note
  description String?  @db.Text

  @@index([taskId, completedAt(sort: Desc)])
  @@map("task_completion")
  @@schema("habitracker_app")
}

model PomodoroSettings {
  taskId            String   @id @db.Uuid
  task              Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  focusDuration     Int      @default(25)
  breakDuration     Int      @default(5)
  longBreakDuration Int      @default(15)
  totalSessions     Int      @default(4)
  isEnabled         Boolean  @default(false)
  autoStartBreaks   Boolean  @default(false)
  autoStartFocus    Boolean  @default(false)

  @@map("pomodoro_settings")
  @@schema("habitracker_app")
}

model Post {
  id                String         @id @default(uuid()) @db.Uuid
  userId            String         @db.Uuid
  profile           HabitProfile   @relation(fields: [userId], references: [userId])
  groupId           String?        @db.Uuid
  group             Group?         @relation(fields: [groupId], references: [id])
  challengeId       String?        @db.Uuid
  challenge         Challenge?     @relation(fields: [challengeId], references: [id])
  content           String?       @db.Text
  type              PostType      @default(TEXT)
  mediaUrl          String?
  visibility        PostVisibility @default(PUBLIC)
  isAutoGenerated   Boolean       @default(false)
  challengeTitle    String?
  taggedUserIds     String[]
  pendingTagUserIds String[]
  rejectedTagUserIds String[]
  hashtags          String[]
  commentCount      Int           @default(0)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  comments          Comment[]
  likes             Like[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([groupId])
  @@index([challengeId])
  @@map("post")
  @@schema("habitracker_app")
}

model Comment {
  id        String       @id @default(uuid()) @db.Uuid
  postId    String       @db.Uuid
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String       @db.Uuid
  profile   HabitProfile @relation(fields: [userId], references: [userId])
  content   String       @db.Text
  createdAt DateTime     @default(now())

  @@index([postId])
  @@map("comment")
  @@schema("habitracker_app")
}

model Like {
  postId    String  @db.Uuid
  post      Post    @relation(fields: [postId], references: [id])
  userId    String  @db.Uuid
  profile   HabitProfile @relation(fields: [userId], references: [userId])
  createdAt DateTime     @default(now())

  @@unique([postId, userId])
  @@map("like")
  @@schema("habitracker_app")
}

model Challenge {
  id                    String            @id @default(uuid()) @db.Uuid
  groupId               String            @db.Uuid
  group                 Group             @relation(fields: [groupId], references: [id])
  creatorId             String            @db.Uuid
  creator               HabitProfile      @relation("challengeCreator", fields: [creatorId], references: [userId])
  title                 String
  description           String?
  status                ChallengeStatus  @default(ACTIVE)
  imageUrl              String?
  taskTemplate          Json?
  startDate             DateTime
  endDate               DateTime?
  autoCreateTaskOnJoin  Boolean           @default(true)
  autoPostOnProgress    Boolean           @default(true)
  autoPostOnCompletion  Boolean           @default(true)
  onTrackStreakThreshold Int              @default(3)
  members               ChallengeMember[]
  tasks                 Task[]
  posts                 Post[]

  @@index([groupId])
  @@index([creatorId])
  @@map("challenge")
  @@schema("habitracker_app")
}

model Group {
  id                 String       @id @default(uuid()) @db.Uuid
  name               String
  description        String?
  coverImageUrl      String?
  profileImageUrl    String?
  isPublic           Boolean      @default(true)
  allowMemberInvites Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  updatedBy          String?
  challenges         Challenge[]
  members            GroupMember[]
  posts              Post[]

  @@map("group")
  @@schema("habitracker_app")
}

model GroupMember {
  id       String       @id @default(uuid()) @db.Uuid
  groupId  String       @db.Uuid
  group    Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId   String       @db.Uuid
  profile  HabitProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  role     String       // ADMIN | MEMBER
  joinedAt DateTime    @default(now())

  @@unique([groupId, userId])
  @@index([userId])
  @@map("group_member")
  @@schema("habitracker_app")
}

model ChallengeMember {
  challengeId   String  @db.Uuid
  challenge     Challenge    @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  userId        String  @db.Uuid
  profile       HabitProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  currentStreak Int          @default(0)
  joinedAt      DateTime     @default(now())

  @@id([challengeId, userId])
  @@map("challenge_member")
  @@schema("habitracker_app")
}

model Notification {
  id                 String             @id @default(uuid()) @db.Uuid
  receiverId         String             @db.Uuid
  receiver           HabitProfile       @relation("notificationReceiver", fields: [receiverId], references: [userId], onDelete: Cascade)
  senderId           String             @db.Uuid
  sender             HabitProfile       @relation("notificationSender", fields: [senderId], references: [userId], onDelete: Cascade)
  notificationTypeId String             @db.Uuid
  notificationType   NotificationTypeRef @relation(fields: [notificationTypeId], references: [id])
  senderName         String
  senderAvatar       String?
  title              String
  body               String             @db.Text
  data               Json               @default("{}")
  isRead             Boolean            @default(false)
  createdAt          DateTime           @default(now())

  @@index([receiverId, isRead, createdAt(sort: Desc)])
  @@index([notificationTypeId])
  @@map("notification")
  @@schema("habitracker_app")
}
